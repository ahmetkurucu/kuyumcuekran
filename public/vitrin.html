<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Kuyumcu Vitrin</title>
  <style>
    :root{
      --fs-title: clamp(28px, 4.8vw, 92px);
      --fs-th:    clamp(20px, 2.6vw, 54px);
      --fs-td:    clamp(24px, 3.0vw, 64px);
      --fs-td-lg: clamp(26px, 3.4vw, 76px);
      --row-h:    clamp(56px, 8.8vh, 140px);
      --pad-x:    clamp(8px, 2vw, 26px);
      --gold:#ffd700; --gold-soft:#ffe680; --red:#ef4444; --green:#22c55e;
      --bg:#000; --panel:#0b0b0b; --line:#2a2a2a;
    }
    *{box-sizing:border-box;margin:0;padding:0}
    html,body{height:100%}
    body{background:var(--bg);color:var(--gold);font-family:Arial,Helvetica,sans-serif;overflow:hidden}

    .bg-pattern{
      position:fixed;inset:0;z-index:0;pointer-events:none;
      background:
        radial-gradient(130% 90% at -20% -10%, rgba(255,215,0,.055), transparent 60%),
        radial-gradient(120% 85% at 120% 120%, rgba(255,215,0,.045), transparent 55%),
        url("data:image/svg+xml;utf8,<svg xmlns='http://www.w3.org/2000/svg' width='120' height='120' viewBox='0 0 120 120'><g fill='none' stroke='%23ffd700' stroke-width='2' opacity='.16'><circle cx='28' cy='28' r='18'/><polygon points='80,14 92,26 80,38 68,26'/><line x1='80' y1='38' x2='92' y2='50'/><line x1='80' y1='38' x2='68' y2='50'/><ellipse cx='28' cy='92' rx='20' ry='12'/><circle cx='92' cy='84' r='2'/><circle cx='12' cy='58' r='2'/><circle cx='102' cy='16' r='2'/></g></svg>");
      background-size:cover,cover,240px 240px;
      background-attachment:fixed;
      mix-blend-mode:soft-light;
      filter:saturate(.9) blur(.2px);
      opacity:.22;
    }

    .ticker-wrap,.hud,.content,.settings-btn,.panel{position:relative;z-index:1}

    .ticker-wrap{position:fixed;left:0;right:0;top:0;height:calc(var(--row-h)*0.9);
      background:linear-gradient(90deg,#111 0%,#222 30%,#111 100%);
      border-bottom:2px solid #3a3a3a;z-index:20;display:flex;align-items:center}
    .ticker{white-space:nowrap;overflow:hidden;width:100%}
    .ticker>span{display:inline-block;padding-left:100%;animation:ticker 18s linear infinite;
      font-weight:800;text-transform:uppercase;font-size:var(--fs-title);letter-spacing:1px;
      -webkit-text-stroke:1px rgba(0,0,0,.5);text-shadow:0 0 10px rgba(255,215,0,.35)}
    @keyframes ticker{0%{transform:translateX(0)}100%{transform:translateX(-100%)}}

    .hud{position:fixed;top:8px;right:10px;z-index:30;text-align:right;
      font-size:clamp(14px,1.4vw,26px);color:#cfcfcf}
    .hud .time{font-weight:700;color:var(--gold-soft)}
    .hud .upd{margin-top:4px;opacity:.8}

    .content{position:absolute;top:calc(var(--row-h)*0.95);left:0;right:0;bottom:0;overflow:auto;
      padding:0 var(--pad-x) var(--pad-x)}
    table{width:100%;border-collapse:collapse;background:var(--panel)}
    th,td{border-bottom:1px solid var(--line);text-align:center}
    th{position:sticky;top:0;background:#111;z-index:5;height:calc(var(--row-h)*0.75);
      font-size:var(--fs-th);letter-spacing:2px}
    th:first-child{text-align:left;padding-left:var(--pad-x)}
    td{height:var(--row-h);font-size:var(--fs-td);font-weight:700}
    td:first-child{text-align:left;padding-left:var(--pad-x)}
    td:nth-child(2){color:var(--red);font-size:var(--fs-td-lg)}
    td:nth-child(3){color:var(--green);font-size:var(--fs-td-lg)}
    tr:nth-child(even){background:#0a0a0a}
    .name-cell{display:flex;align-items:center;gap:14px}
    .coin{filter:drop-shadow(0 0 6px rgba(255,215,0,.35))}
    .arrow{font-size:1.2em;font-weight:900}
    .arrow.up{color:var(--green)} .arrow.down{color:var(--red)} .arrow.stable{color:#777}

    body.fs tr[data-code="USDTRY"],
    body.fs tr[data-code="EURTRY"]{display:none!important}
    body.fs .content{overflow:hidden}

    .settings-btn{position:fixed;left:10px;top:8px;z-index:40;width:50px;height:50px;
      border-radius:50%;border:2px solid #ffd700;background:#374151;color:#ffd700;
      cursor:pointer;font-size:24px;display:flex;align-items:center;justify-content:center;
      transition:.2s}
    .settings-btn:hover{transform:scale(1.06) rotate(8deg)}
    .panel{position:fixed;left:10px;top:68px;z-index:45;display:none;min-width:220px;
      background:#111;border:2px solid #ffd700;border-radius:12px;padding:12px}
    .panel.active{display:block}
    .panel h4{color:#ffd700;margin:2px 0 8px 2px;font-size:16px;border-bottom:1px solid #333;
      padding-bottom:6px}
    .panel .btn{width:100%;border:none;border-radius:8px;padding:10px 12px;margin:6px 0;
      color:#fff;cursor:pointer;font-weight:700;font-size:15px;opacity:.95}
    .btn-full{background:#22c55e}.btn-admin{background:#ef4444}
    .btn-zoomin,.btn-zoomout{background:#3b82f6}.btn-reset{background:#6b7280}
    .status{position:fixed;right:10px;bottom:8px;z-index:50;font-size:clamp(12px,1.2vw,18px);color:#bbb}
  </style>
</head>
<body>
  <div class="bg-pattern"></div>

  <button class="settings-btn" id="btnSettings">‚öôÔ∏è</button>
  <div class="panel" id="panel">
    <h4>‚öôÔ∏è Ayarlar</h4>
    <button class="btn btn-zoomin"  id="btnZoomIn">üîç Yakƒ±nla≈ütƒ±r</button>
    <button class="btn btn-zoomout" id="btnZoomOut">üîé Uzakla≈ütƒ±r</button>
    <button class="btn btn-reset"   id="btnReset">%100 Sƒ±fƒ±rla</button>
    <button class="btn btn-full"    id="btnFull">‚õ∂ Tam Ekran</button>
    
    <h4 style="margin-top:16px">üì± Sayfalar</h4>
    <button class="btn btn-admin" onclick="location.href='/admin.html'">üë®‚Äçüíº Admin Panel</button>
  </div>

  <div class="ticker-wrap"><div class="ticker"><span id="marquee">KUYUMCU</span></div></div>

  <div class="hud">
    <div class="time" id="clock">00:00:00</div>
    <div class="upd" id="upd">G√ºncelleniyor‚Ä¶</div>
  </div>

  <div class="content">
    <table id="tbl">
      <thead><tr><th id="thShop">KUYUMCU</th><th>ALI≈û</th><th>SATI≈û</th><th>DEƒûƒ∞≈ûƒ∞M</th></tr></thead>
      <tbody id="tbody"></tbody>
    </table>
  </div>

  <div class="status" id="status"></div>

<script>
  const token = localStorage.getItem('token');
  if (!token) {
    alert('L√ºtfen giri≈ü yapƒ±n!');
    window.location.href = '/login.html';
  }

  const API_BASE = window.location.origin + '/api';
  const user = JSON.parse(localStorage.getItem('user') || '{}');
  const shop = (user.full_name || user.username || 'KUYUMCU').toUpperCase();
  
  document.getElementById("marquee").textContent = ` ${shop} ‚Äî Canlƒ± Altƒ±n Fiyatlarƒ± `.repeat(3);
  document.getElementById("thShop").textContent = shop;

  const clockEl = document.getElementById("clock");
  function tick() {
    const d = new Date();
    clockEl.textContent = d.toLocaleTimeString("tr-TR", { hour12: false });
  }
  tick();
  setInterval(tick, 1000);

  const NAMES = {
    ALTIN: "HAS Altƒ±n",
    KULCEALTIN: "Gram Altƒ±n",
    AYAR22: "22 Ayar Altƒ±n",
    CEYREK_YENI: "√áeyrek (Yeni)",
    CEYREK_ESKI: "√áeyrek (Eski)",
    YARIM_YENI: "Yarƒ±m (Yeni)",
    YARIM_ESKI: "Yarƒ±m (Eski)",
    TEK_YENI: "Tam (Yeni)",
    TEK_ESKI: "Tam (Eski)",
    ATA_YENI: "Ata",
    USDTRY: "Dolar",
    EURTRY: "Euro"
  };

  const tbody = document.getElementById("tbody");
  const statusEl = document.getElementById("status");
  const updEl = document.getElementById("upd");
  let last = {};

  function rowHTML(code, alis, satis) {
    let d = "stable";
    if (last[code] != null) {
      if (satis > last[code]) d = "up";
      else if (satis < last[code]) d = "down";
    }
    last[code] = satis;
    
    const arr = d === "up" ? "‚ñ≤" : d === "down" ? "‚ñº" : "‚Äî";
    const n = NAMES[code] || code;
    
    return `<tr data-code="${code}">
      <td>
        <div class="name-cell">
          <svg class="coin" width="34" height="34" viewBox="0 0 24 24" fill="#ffd700">
            <circle cx="12" cy="12" r="10"/>
            <circle cx="12" cy="12" r="6" fill="#e0c200"/>
          </svg>
          ${n}
        </div>
      </td>
      <td>${alis.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ‚Ç∫</td>
      <td>${satis.toLocaleString('tr-TR', { minimumFractionDigits: 2, maximumFractionDigits: 2 })} ‚Ç∫</td>
      <td><span class="arrow ${d}">${arr}</span></td>
    </tr>`;
  }

  async function load() {
    try {
      updEl.textContent = "G√ºncelleniyor‚Ä¶";
      
      const response = await fetch(`${API_BASE}/fiyat/current`, {
        headers: { 
          'Accept': 'application/json',
          'Authorization': `Bearer ${token}`
        },
        cache: 'no-store'
      });

      if (!response.ok) throw new Error(`HTTP ${response.status}`);

      const result = await response.json();
      
      if (!result.success) throw new Error(result.message || 'Veri alƒ±namadƒ±');

      const data = result.data;
      const metadata = result.metadata || {};
      
      const order = ["ALTIN", "KULCEALTIN", "AYAR22", "CEYREK_YENI", "CEYREK_ESKI", 
                     "YARIM_YENI", "YARIM_ESKI", "TEK_YENI", "TEK_ESKI", "ATA_YENI", 
                     "USDTRY", "EURTRY"];

      let html = '';
      order.forEach(code => {
        const alis = data[`${code}_alis`] || 0;
        const satis = data[`${code}_satis`] || 0;
        if (alis > 0 || satis > 0) {
          html += rowHTML(code, alis, satis);
        }
      });

      tbody.innerHTML = html;
      
      // API'den gelen ger√ßek g√ºncelleme zamanƒ±
      if (metadata.status?.cacheUpdatedAt) {
        const cacheTime = new Date(metadata.status.cacheUpdatedAt);
        const now = new Date();
        const diffMs = now - cacheTime;
        const diffMin = Math.floor(diffMs / 60000);
        
        updEl.textContent = `Son: ${cacheTime.toLocaleTimeString('tr-TR')}`;
        
        // 5 dakikadan eski ise uyarƒ± g√∂ster
        if (diffMin >= 5) {
          statusEl.textContent = "‚ö†Ô∏è Sƒ∞STEM AKTƒ∞F DEƒûƒ∞LDƒ∞R";
          statusEl.style.color = "#ef4444";
          statusEl.style.fontWeight = "bold";
        } else {
          statusEl.textContent = "";
        }
      } else {
        updEl.textContent = `Son: ${new Date().toLocaleTimeString('tr-TR')}`;
        statusEl.textContent = "";
      }

    } catch (e) {
      console.error('Fiyat y√ºkleme hatasƒ±:', e);
      statusEl.textContent = "‚ö†Ô∏è " + e.message;
      updEl.textContent = "Hata";
    }
  }

  load();
  
  // 20 saniyede bir otomatik yenile
  let intervalId = setInterval(load, 20000);
  
  // Sayfa geri geldiƒüinde hemen yenile ve interval'i sƒ±fƒ±rla
  document.addEventListener('visibilitychange', () => {
    if (!document.hidden) {
      load(); // Hemen yenile
      clearInterval(intervalId);
      intervalId = setInterval(load, 20000); // Interval'i yeniden ba≈ülat
    }
  });
  
  // Focus geri geldiƒüinde de yenile
  window.addEventListener('focus', () => {
    load();
  });

  const btn = document.getElementById("btnSettings");
  const panel = document.getElementById("panel");
  btn.onclick = () => panel.classList.toggle("active");
  document.addEventListener("click", e => {
    if (!panel.contains(e.target) && e.target !== btn) panel.classList.remove("active");
  });

  let zoom = 1.0;
  function applyZoom() {
    document.body.style.transform = `scale(${zoom})`;
    document.body.style.transformOrigin = "top center";
  }

  document.getElementById("btnZoomIn").onclick = () => { zoom = Math.min(2.5, zoom + 0.1); applyZoom(); };
  document.getElementById("btnZoomOut").onclick = () => { zoom = Math.max(0.6, zoom - 0.1); applyZoom(); };
  document.getElementById("btnReset").onclick = () => { zoom = 1; applyZoom(); };

  document.getElementById("btnFull").onclick = () => {
    if (!document.fullscreenElement) document.documentElement.requestFullscreen();
    else document.exitFullscreen();
  };

  document.addEventListener("fullscreenchange", () => {
    if (document.fullscreenElement) document.body.classList.add("fs");
    else document.body.classList.remove("fs");
  });
</script>
</body>
</html>